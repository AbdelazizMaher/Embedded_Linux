# Yocto Project

**Yocto project** provides open source, high quality infrastructure and tools to help developers create their own custom Linux distributions for any hardware architecture.

**Yocto?** 
Yocto is the smallest SI metric system prefix Like 'm' stands for milli ( 10^-3 ).So is yocto ( y = 10^-24 )

		
## What is Yocto Project

To understand the outcome provided by the Yocto Project, we can use the analogy of the computing machine

**Input:** Set of data that describes what we want, that is our specification 

		 (Kernel Configuration, Hardware Name, Packages/Binaries to be installed)

**Output:** Linux Based Embedded Product 

		 (Linux Kernel, Root File System, Bootloader, Device Tree, Toolchain)
		
		
## Setting up Build Machine

### Prerequisites

1. 50 Gbytes of free disk space

2. Runs a supported Linux distribution (i.e. recent releases of Fedora, openSUSE, CentOS, Debian, or Ubuntu). 

3. 
	Git 1.8.3.1 or greater

	tar 1.27 or greater

	Python 3.4.0 or greater.

#### Packages and package installation vary depending on your development system.

- [x] Install the required packages for Yocto to Work from
        https://www.yoctoproject.org/docs/latest/ref-manual/ref-manual.html#ubuntu-packages

```bash
sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib \
build-essential chrpath socat cpio python python3 python3-pip python3-pexpect \
xz-utils debianutils iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev \
pylint3 xterm
```
    
## Workflow of Yocto Project

Step 1: Download the Poky Source code

```bash
git clone git://git.yoctoproject.org/poky
```

Step 2: Checkout the latest Long Time Support release (dunfell)

```bash
git checkout dunfell 
```

Step 3: Prepare the build environment

Poky provides you a script **'oe-init-build-env'**, which should be used to setup the build environment, This script will set up your environment to use Yocto build system,including adding the BitBake utility to your path

```bash
# Here build_directory is an optional argument for the name of the directory where the environment is set
#in case it is not given , it defaults to "build"
source poky/oe-init-build-env [ build_directory ]
```

The above script will move you in a build folder and create two files `**( local.conf, bblayers.conf )**` inside conf folder

Step 4: Building Linux Distribution

```bash
#core-image-minimal --->> This is a small image allowing a device to boot, and it is very useful for kernel and boot loader tests and development
bitbake <image_name>
```

## Command to run the generated image in QEMU

Quick Emulator ( QEMU ) is a free and open source software package that performs hardware virtualization.

Poky provides a script 'runqemu' which will allow you to start the QEMU using yocto generated images.

The runqemu script is run as:
   ```bash
   runqemu <machine> <zimage> <filesystem>
   ```
**where:**

   `<machine>` is the machine/architecture to use (qemuarm/qemumips/qemuppc/qemux86/qemux86-64)
   
   `<zimage>` is the path to a kernel (e.g. zimage-qemuarm.bin)
   
   `<filesystem>` is the path to an ext2 image (e.g. filesystem-qemuarm.ext2) or an nfs directory

**Exit QEMU** by either clicking on the shutdown icon or by typing **Ctrl-C** in the QEMU transcript window from which you evoked QEMU.

**Nographic** You can launch QEMU without the graphic window by adding `**nographic**` to the command line


### To add a particular package in your root file system

Open your local.conf file and add the recipe name below
```bash
IMAGE_INSTALL:append = " recipe-name"
```

**Note** avoid using +=, =+, .= and =. in `$BUILDDIR/conf/local.conf`. Always use **overrides**


BB_NUMBER_THREADS

	Determines the number of tasks that Bitbake will perform in parallel
	Note: These tasks are related to bitbake and nothing related to compiling
	Defaults to the number of CPUs on the system 
 
	bitbake -e core-image-minimal | grep ^BB_NUMBER_THREADS=
	

PARALLEL_MAKE

	Corresponds to the -j make option
	specifies the number of processes that GNU make can run in parallel on a compilation task
	Defaults to the number of CPUs on the system
 
	bitbake -e core-image-minimal | grep ^PARALLEL_MAKE=

	
### Images generated by Poky Build

The build process writes images out to the Build Directory inside the tmp/deploy/images/machine/ folder

1. kernel-image:
   
		A kernel binary file
		The KERNEL_IMAGETYPE variable determines the naming scheme for the kernel image file.

		bitbake -e core-image-minimal | grep ^KERNEL_IMAGETYPE=
		

3. root-filesystem-image:
   
		Root filesystems for the target device (e.g. *.ext3 or *.bz2 files).
		The `**IMAGE_FSTYPES**` variable determines the root filesystem image type
		
		bitbake -e core-image-minimal | grep ^IMAGE_FSTYPES=
   
		
5. kernel-modules:
   
		Tarballs that contain all the modules built for the kernel

7. bootloaders:
   
		If applicable to the target machine, bootloaders supporting the image.

- [x] symlinks
 
	- symbolic link pointing to the most recently built file for each machine
 
	- These links might be useful for external scripts that need to obtain  latest version of each file	

		
### Saving Disk Space while building Yocto 

Yocto Build System can take a lot of disk space during build. But bitbake provides options to preserve disk space

You can tell bitbake to delete all the source code, build files after building a particular recipe by adding the following line in local.conf file
```bash
INHERIT += "rm_work"
```
Disadvantage: Difficult to debug while build fails of any recipe.


## Steps to generate an Yocto Image for Raspberry Pi4

Poky has no support for Broadcom BCM SoC.

Step1: Download the BSP Layer for Raspberry Pi4

```bash
# Make sure to check out to the same branch of poky
git clone git://git.yoctoproject.org/meta-raspberrypi
```

Step2: Download meta-openembedded branch as meta-raspberrypi layer depends upon it

```bash
# Make sure to check out to the same branch of poky
git clone git://git.openembedded.org/meta-openembedded
```

Step4: Run the environment script to setup the Yocto Environment and create build directory

$ source poky/oe-init-build-env [ build_directory ]

Step5: Add meta-openembedded layers ( meta-oe, meta-multimedia, meta-networking, meta-python) and meta-raspberrypi layer to bblayers.conf

Step6: Set the MACHINE in local.conf to "raspberrypi3".
$ echo 'MACHINE = "raspberrypi4_64"' >> conf/local.conf

Step7: Final step is to build the image. To find out the available images:
$ ls ../meta-raspberrypi/recipes-*/images/


## Images

**`rpi-hwup-image.bb`**: This is an image based on core-image-minimal

**`rpi-basic-image.bb`**: This is an image based on rpi-hwup-image.bb, with some added features (a splash screen)

**`rpi-test-image.bb`**: This is an image based on rpi-basic-image.bb, which includes some packages present in meta-raspberrypi

### Enabling UART

RaspberryPi 4 does not have the UART enabled by default because this needs a fixed core frequency and enable_uart wil set it to the minimum

To enable it, set the following in local.conf
```bash
ENABLE_UART = "1"
```


### Flashing images on SD Card

Images are present in tmp/deploy/images/raspberrypi4-64

```bash
lsblk

sudo dd if=rpi-hwup-image-raspberrypi4-64.rpi-sdimg of=/dev/sdb bs=4096 && sync
```

### Remotely access raspberry pi4

**dropbear** is a SSH 2 server designed to be small enough to be used in small memory environments

1. Use basic or test images
```bash
# basic image supports dropbear unlike hwup image
bitbake rpi-basic-image
```

2. Append the package in local.conf
```bash
# adds dropbear to the packages installed on the image.
IMAGE_INSTALL:append = " dropbear"
```

			
	
